name: Inspect OIDC Token Claims

on:
  workflow_dispatch:

jobs:
  inspect-oidc:
    runs-on: ubuntu-latest
    permissions:
      id-token: write  # Allows OIDC token generation
      contents: read   # To access the repository contents

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Get OIDC Token
      id: oidc-token
      run: |
        # Request the OIDC token
        OIDC_TOKEN=$(curl -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
        "$ACTIONS_ID_TOKEN_REQUEST_URL" | jq -r .value)

        echo "OIDC Token: $OIDC_TOKEN"

        # Function to add padding if necessary for base64 decoding
        pad_base64() {
          local len=$((${#1} % 4))
          if [ "$len" -eq 2 ]; then
            echo "$1"'=='
          elif [ "$len" -eq 3 ]; then
            echo "$1"'='
          else
            echo "$1"
          fi
        }

        # Extract parts of the token
        HEADER_PART=$(echo "$OIDC_TOKEN" | cut -d "." -f1)
        PAYLOAD_PART=$(echo "$OIDC_TOKEN" | cut -d "." -f2)
        SIGNATURE_PART=$(echo "$OIDC_TOKEN" | cut -d "." -f3)

        # Debug output
        echo "Header Part: $HEADER_PART"
        echo "Payload Part: $PAYLOAD_PART"
        echo "Signature Part: $SIGNATURE_PART"

        # Decode the parts
        HEADER=$(echo "$HEADER_PART" | pad_base64 | base64 --decode 2>/dev/null)
        PAYLOAD=$(echo "$PAYLOAD_PART" | pad_base64 | base64 --decode 2>/dev/null)
        SIGNATURE=$SIGNATURE_PART

        # Print out the decoded parts
        echo "OIDC Header: $HEADER"
        echo "OIDC Payload: $PAYLOAD"
        echo "OIDC Signature: $SIGNATURE"
